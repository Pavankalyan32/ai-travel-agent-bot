<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Agent Bot - Murmu</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <script src="https://js.puter.com/v2/"></script>
  <script src="travel-agent-data.js"></script>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      background: #fafbfc;
      font-family: 'Inter', sans-serif;
    }
    .ask-center {
      min-height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f3f0ff 0%, #fafbfc 100%);
      padding: 20px;
    }
    .ask-title {
      color: #8b5cf6;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }
    .ask-desc {
      color: #5b6478;
      font-size: 1.25rem;
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Quick Action Buttons */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 30px;
      max-width: 600px;
    }
    .quick-btn {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    .quick-btn:active {
      transform: translateY(0);
    }
    .quick-btn:focus {
      outline: 2px solid #8b5cf6;
      outline-offset: 2px;
    }
    
    /* Travel Checklist */
    .checklist-container {
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      display: none;
    }
    .checklist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .checklist-title {
      font-weight: 600;
      color: #8b5cf6;
    }
    .checklist-toggle {
      background: none;
      border: none;
      color: #8b5cf6;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .checklist-item:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    .checklist-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    .checklist-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    /* Real-time Data Display */
    .realtime-data {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .data-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      min-width: 120px;
      text-align: center;
    }
    .data-label {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 5px;
    }
    .data-value {
      font-weight: 600;
      color: #8b5cf6;
    }
    
    .ask-mic-btn {
      background: radial-gradient(circle at 30% 30%, #a78bfa 60%, #7c3aed 100%);
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2.2rem;
      box-shadow: 0 4px 24px 0 #a78bfa33;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: pulse 1.5s infinite;
      position: relative;
    }
    .ask-mic-btn.recording {
      animation: recording-pulse 0.8s infinite;
      background: radial-gradient(circle at 30% 30%, #ef4444 60%, #dc2626 100%);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 #a78bfa55; }
      70% { box-shadow: 0 0 0 24px #a78bfa11; }
      100% { box-shadow: 0 0 0 0 #a78bfa55; }
    }
    @keyframes recording-pulse {
      0% { box-shadow: 0 0 0 0 #ef444455; transform: scale(1); }
      50% { box-shadow: 0 0 0 20px #ef444422; transform: scale(1.05); }
      100% { box-shadow: 0 0 0 0 #ef444455; transform: scale(1); }
    }
    .ask-mic-btn:active {
      transform: scale(0.95);
    }
    .ask-mic-btn i {
      transition: transform 0.2s;
    }
    .ask-mic-btn:hover i {
      transform: scale(1.2) rotate(-8deg);
    }
    .ask-mic-btn:focus {
      outline: 3px solid #8b5cf6;
      outline-offset: 3px;
    }
    
    /* Conversation History */
    .conversation-container {
      width: 100%;
      max-width: 600px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
    }
    .conversation-item {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 10px;
      animation: slideIn 0.3s ease;
    }
    .conversation-item.user {
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      margin-left: 20px;
      border-left: 4px solid #8b5cf6;
    }
    .conversation-item.bot {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      margin-right: 20px;
      border-left: 4px solid #10b981;
    }
    .conversation-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 5px;
      opacity: 0.7;
    }
    .conversation-text {
      font-size: 0.95rem;
      line-height: 1.4;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ask-result {
      margin-top: 20px;
      color: #444;
      font-size: 1.15rem;
      text-align: center;
      max-width: 600px;
      min-height: 40px;
      transition: all 0.3s ease;
      word-break: break-word;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
    }
    .ask-loading {
      margin-top: 20px;
      color: #8b5cf6;
      font-size: 1.1rem;
      text-align: center;
      font-style: italic;
      animation: fadeIn 0.5s;
      padding: 15px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 15px;
      border: 2px dashed #8b5cf6;
    }
    .ai-indicator {
      display: inline-block;
      margin-left: 8px;
      font-size: 0.8rem;
      color: #10b981;
      font-weight: 600;
    }
    .ai-indicator i {
      margin-right: 4px;
    }
    .enhanced-indicator {
      display: inline-block;
      margin-left: 8px;
      font-size: 0.8rem;
      color: #8b5cf6;
      font-weight: 600;
    }
    .enhanced-indicator i {
      margin-right: 4px;
    }
    .ask-refresh-btn {
      margin-top: 16px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #4b5563;
      font-size: 1rem;
      padding: 10px 24px;
      border-radius: 25px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .ask-refresh-btn:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .ask-refresh-btn:active {
      transform: translateY(0);
    }
    .ask-refresh-btn:focus {
      outline: 2px solid #8b5cf6;
      outline-offset: 2px;
    }
    
    /* Status indicator */
    .status-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10b981;
      border: 3px solid white;
      animation: status-pulse 2s infinite;
    }
    .status-indicator.recording {
      background: #ef4444;
      animation: status-recording 0.8s infinite;
    }
    @keyframes status-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes status-recording {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.2); }
    }
    
    /* Voice Commands Help */
    .voice-help {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.2);
      backdrop-filter: blur(10px);
      max-width: 300px;
      display: none;
      z-index: 1000;
    }
    .voice-help h4 {
      margin: 0 0 10px 0;
      color: #8b5cf6;
    }
    .voice-command {
      margin: 5px 0;
      font-size: 0.9rem;
    }
    .voice-command strong {
      color: #8b5cf6;
    }
    
    /* Keyboard shortcuts */
    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      display: none;
    }
    
    @media (max-width: 700px) {
      .ask-title { font-size: 2rem; }
      .ask-desc { font-size: 1rem; }
      .ask-mic-btn { width: 70px; height: 70px; font-size: 1.5rem; }
      .ask-result, .ask-loading { font-size: 1rem; }
      .quick-actions { gap: 8px; }
      .quick-btn { font-size: 0.8rem; padding: 6px 12px; }
      .conversation-container { max-height: 250px; }
      .realtime-data { gap: 8px; }
      .data-card { min-width: 100px; }
    }
  </style>
</head>
<body>
  <div class="ask-center">
    <div class="ask-title">Murmu</div>
    <div class="ask-desc">AI-powered travel assistant - Ask me about destinations, flights, hotels, and travel tips</div>
    
    <!-- Real-time Data Display -->
    <div class="realtime-data" id="realtimeData">
      <div class="data-card">
        <div class="data-label">Weather</div>
        <div class="data-value" id="weatherData">Loading...</div>
      </div>
      <div class="data-card">
        <div class="data-label">USD/EUR</div>
        <div class="data-value" id="currencyData">Loading...</div>
      </div>
      <div class="data-card">
        <div class="data-label">Flight Deals</div>
        <div class="data-value" id="flightData">Loading...</div>
      </div>
      <div class="data-card" id="userProfileCard" style="display: none;">
        <div class="data-label">Your Profile</div>
        <div class="data-value" id="userProfileData">Set preferences</div>
      </div>
    </div>
    
    <!-- Travel Checklist -->
    <div class="checklist-container" id="checklistContainer">
      <div class="checklist-header">
        <div class="checklist-title">Travel Checklist</div>
        <button class="checklist-toggle" id="checklistToggle">×</button>
      </div>
      <div id="checklistItems">
        <div class="checklist-item">
          <input type="checkbox" id="check1">
          <label for="check1">Passport and visa documents</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check2">
          <label for="check2">Travel insurance</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check3">
          <label for="check3">Flight tickets</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check4">
          <label for="check4">Hotel reservations</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check5">
          <label for="check5">Currency exchange</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check6">
          <label for="check6">Packing essentials</label>
        </div>
      </div>
    </div>
    
    <!-- Quick Action Buttons -->
    <div class="quick-actions">
      <button class="quick-btn" data-action="destinations">🌍 Destinations</button>
      <button class="quick-btn" data-action="flights">✈️ Flights</button>
      <button class="quick-btn" data-action="hotels">🏨 Hotels</button>
      <button class="quick-btn" data-action="budget">💰 Budget</button>
      <button class="quick-btn" data-action="weather">🌤️ Weather</button>
      <button class="quick-btn" data-action="visa">📋 Visa</button>
      <button class="quick-btn" data-action="insurance">🛡️ Insurance</button>
      <button class="quick-btn" data-action="packing">🧳 Packing</button>
      <button class="quick-btn" data-action="recommendations">💡 Smart Recommendations</button>
    </div>
    
    <select id="langSelect" style="margin-bottom:20px; padding:8px 18px; border-radius:8px; border:1px solid #e5e7eb; font-size:1rem; font-family:inherit; outline:none; background:white;">
      <option value="en-US">English</option>
      <option value="hi-IN">हिन्दी</option>
      <option value="ru-RU">Русский</option>
      <option value="ja-JP">日本語</option>
    </select>
    
    <button class="ask-mic-btn" id="micBtn" tabindex="0">
      <i class="fa-solid fa-microphone"></i>
      <div class="status-indicator" id="statusIndicator"></div>
    </button>
    
    <!-- Text Input for Manual Entry -->
    <div id="textInputContainer" style="margin:20px 0; width:100%; max-width:400px;">
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" id="textInput" placeholder="Type your travel question..." 
               style="flex:1; padding:12px 16px; border:2px solid #e5e7eb; border-radius:25px; font-size:1rem; outline:none; transition:border-color 0.3s;">
        <button id="sendBtn" style="padding:12px 20px; background:#8b5cf6; color:white; border:none; border-radius:25px; cursor:pointer; font-size:1rem;">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
    
    <!-- Conversation History -->
    <div class="conversation-container" id="conversationContainer">
      <div class="conversation-item bot">
        <div class="conversation-label">AI Travel Agent</div>
        <div class="conversation-text" id="welcomeMessage">Hello! I'm your AI-powered travel assistant. I can help you plan your next adventure with intelligent recommendations and personalized advice. Ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!</div>
      </div>
    </div>
    
    <div id="askLoading" class="ask-loading" style="display:none;">
      <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i>
      Listening...
    </div>
    <div id="askResult" class="ask-result" style="display:none;"></div>
    
    <button class="ask-refresh-btn" id="refreshBtn" tabindex="0">
      <i class="fa-solid fa-rotate-right" style="margin-right:6px;"></i> New Conversation
    </button>
  </div>

  <!-- Voice Commands Help -->
  <div class="voice-help" id="voiceHelp">
    <h4>Voice Commands</h4>
    <div class="voice-command"><strong>"Show checklist"</strong> - Open travel checklist</div>
    <div class="voice-command"><strong>"Voice commands"</strong> - Show this help</div>
    <div class="voice-command"><strong>"Set budget [amount]"</strong> - Save your budget</div>
    <div class="voice-command"><strong>"I prefer [style]"</strong> - Set travel style</div>
    <div class="voice-command"><strong>"Save destination [name]"</strong> - Remember destination</div>
    <div class="voice-command"><strong>"Clear conversation"</strong> - Start fresh</div>
  </div>

  <!-- Keyboard Shortcuts Hint -->
  <div class="keyboard-hint" id="keyboardHint">
    Press 'H' for voice commands help, 'C' for checklist, 'Space' to speak
  </div>

  <script>
    const micBtn = document.getElementById('micBtn');
    const askResult = document.getElementById('askResult');
    const askLoading = document.getElementById('askLoading');
    const langSelect = document.getElementById('langSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const conversationContainer = document.getElementById('conversationContainer');
    const statusIndicator = document.getElementById('statusIndicator');
    const quickButtons = document.querySelectorAll('.quick-btn');
    const checklistContainer = document.getElementById('checklistContainer');
    const checklistToggle = document.getElementById('checklistToggle');
    const voiceHelp = document.getElementById('voiceHelp');
    const keyboardHint = document.getElementById('keyboardHint');
    const realtimeData = document.getElementById('realtimeData');
    
    let recognizing = false;
    let recognition;
    let currentLang = langSelect.value;
    let conversationHistory = [];
    let isChecklistVisible = false;
    let isVoiceHelpVisible = false;
    
    // User preferences and travel profile
    let userPreferences = {
      budget: null,
      travelStyle: null,
      preferredDestinations: [],
      interests: [],
      accessibility: false,
      familyTravel: false
    };

    // Function to clean text for speech synthesis
    function cleanTextForSpeech(text) {
      if (!text) return '';
      
      // Remove emojis and special symbols but preserve international characters
      let cleaned = text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
      
      // Remove bullet points and list markers
      cleaned = cleaned.replace(/^[\s•\-\*]+/gm, '');
      cleaned = cleaned.replace(/^\d+\.\s*/gm, '');
      
      // Clean up spacing but preserve international characters
      cleaned = cleaned.replace(/\s+/g, ' ');
      cleaned = cleaned.replace(/\s+([.,!?])/g, '$1');
      
      return cleaned.trim();
    }

    // Text cleaning and shortening function
    function cleanAndShortenText(text) {
      if (!text) return '';
      
      // Remove extra whitespace and normalize
      let cleaned = text.replace(/\s+/g, ' ').trim();
      
      // Remove emojis and special symbols but preserve international characters
      cleaned = cleaned.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
      
      // Remove common AI artifacts and formal language
      cleaned = cleaned.replace(/^(Here's|Here is|I'll|I will|Let me|Based on|According to|I can|I would|I'd)/gi, '');
      cleaned = cleaned.replace(/(\.|,|!|\?)\s*(Here's|Here is|I'll|I will|Let me|Based on|According to|I can|I would|I'd)/gi, '$1');
      
      // Remove redundant phrases
      cleaned = cleaned.replace(/\b(please note that|it's worth noting that|it's important to|keep in mind that|remember that)\b/gi, '');
      cleaned = cleaned.replace(/\b(in terms of|when it comes to|as far as|regarding|concerning)\b/gi, '');
      
      // Remove bullet points and list markers
      cleaned = cleaned.replace(/^[\s•\-\*]+/gm, '');
      cleaned = cleaned.replace(/^\d+\.\s*/gm, '');
      
      // Shorten long sentences by breaking at natural points
      const sentences = cleaned.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const shortSentences = sentences.map(sentence => {
        let short = sentence.trim();
        
        // Allow longer sentences for detailed responses
        if (short.length > 150) {
          const parts = short.split(/[,;]/);
          if (parts.length > 1) {
            short = parts[0].trim();
          }
        }
        
        // Keep all content for maximum detail
        // Only remove the most redundant words
        short = short.replace(/\b(very|really|quite|extremely|absolutely)\b/gi, '');
        
        return short;
      });
      
      // Limit to 10 sentences for detailed but manageable responses
      const finalSentences = shortSentences.slice(0, 10);
      
      // Join and clean up
      let result = finalSentences.join('. ').trim();
      if (!result.endsWith('.') && !result.endsWith('!') && !result.endsWith('?')) {
        result += '.';
      }
      
      // Final cleanup
      result = result.replace(/\.+/g, '.');
      result = result.replace(/\s+/g, ' ');
      result = result.replace(/\s+([.,!?])/g, '$1'); // Remove spaces before punctuation
      
      return result;
    }





    // Real-time Data Simulation
    function updateRealtimeData() {
      const weatherData = document.getElementById('weatherData');
      const currencyData = document.getElementById('currencyData');
      const flightData = document.getElementById('flightData');
      
      // Simulate real-time updates
      const weatherConditions = ['☀️ 72°F', '🌤️ 68°F', '⛅ 75°F', '🌧️ 65°F'];
      const currencyRates = ['$1.08', '$1.12', '$1.05', '$1.15'];
      const flightDeals = ['$299', '$349', '$399', '$449'];
      
      weatherData.textContent = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
      currencyData.textContent = currencyRates[Math.floor(Math.random() * currencyRates.length)];
      flightData.textContent = flightDeals[Math.floor(Math.random() * flightDeals.length)];
    }

    // Update data every 30 seconds
    setInterval(updateRealtimeData, 30000);
    updateRealtimeData();
    
    // Test function to verify language preservation
    function testLanguagePreservation() {
      const testTexts = {
        'Hindi': 'नमस्ते! मैं आपका व्यक्तिगत ट्रैवल एजेंट हूं।',
        'Russian': 'Привет! Я ваш персональный туристический агент.',
        'Japanese': 'こんにちは！私はあなたのパーソナル旅行代理店です。',
        'English': 'Hello! I am your personal travel agent.'
      };
      
      console.log('Testing language preservation:');
      Object.entries(testTexts).forEach(([lang, text]) => {
        const cleaned = cleanTextForSpeech(text);
        console.log(`${lang}: ${cleaned}`);
      });
    }
    
    // Run test on page load
    testLanguagePreservation();
    
    // Function to update welcome message based on current language
    function updateWelcomeMessage() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      const welcomeMessages = {
        'en-US': 'Hello! I\'m your AI-powered travel assistant. I can help you plan your next adventure with intelligent recommendations and personalized advice. Ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!',
        'hi-IN': 'नमस्ते! मैं आपका AI-संचालित यात्रा सहायक हूं। मैं आपकी अगली यात्रा की योजना बनाने में मदद कर सकता हूं। मुझसे गंतव्य, उड़ानें, होटल और यात्रा टिप्स के बारे में पूछें!',
        'ru-RU': 'Привет! Я ваш ИИ-ассистент для путешествий. Я могу помочь спланировать ваше следующее приключение с умными рекомендациями. Спросите меня о направлениях, рейсах, отелях и советах по путешествиям!',
        'ja-JP': 'こんにちは！私はあなたのAI旅行アシスタントです。次回の冒険を計画するお手伝いができます。目的地、フライト、ホテル、旅行のヒントについてお聞きください！'
      };
      if (welcomeMessage) {
        welcomeMessage.textContent = welcomeMessages[currentLang] || welcomeMessages['en-US'];
      }
    }
    
    // Update welcome message on page load
    updateWelcomeMessage();
    
    // Function to update user profile display
    function updateUserProfile() {
      const userProfileCard = document.getElementById('userProfileCard');
      const userProfileData = document.getElementById('userProfileData');
      
      if (userPreferences.budget || userPreferences.travelStyle || userPreferences.preferredDestinations.length > 0) {
        userProfileCard.style.display = 'block';
        const profileInfo = [];
        if (userPreferences.budget) profileInfo.push(`$${userPreferences.budget}`);
        if (userPreferences.travelStyle) profileInfo.push(userPreferences.travelStyle);
        if (userPreferences.preferredDestinations.length > 0) {
          profileInfo.push(userPreferences.preferredDestinations[0]);
        }
        userProfileData.textContent = profileInfo.join(', ');
      } else {
        userProfileCard.style.display = 'none';
      }
    }

    // Checklist functionality
    function toggleChecklist() {
      isChecklistVisible = !isChecklistVisible;
      checklistContainer.style.display = isChecklistVisible ? 'block' : 'none';
    }

    // Voice commands help
    function toggleVoiceHelp() {
      isVoiceHelpVisible = !isVoiceHelpVisible;
      voiceHelp.style.display = isVoiceHelpVisible ? 'block' : 'none';
    }

    // Handle checklist item completion
    document.querySelectorAll('#checklistItems input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const item = this.closest('.checklist-item');
        if (this.checked) {
          item.classList.add('completed');
        } else {
          item.classList.remove('completed');
        }
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'h' || e.key === 'H') {
        toggleVoiceHelp();
        showKeyboardHint('Voice commands help toggled');
      } else if (e.key === 'c' || e.key === 'C') {
        toggleChecklist();
        showKeyboardHint('Checklist toggled');
      } else if (e.key === ' ' && !recognizing) {
        e.preventDefault();
        if (recognition) recognition.start();
      }
    });

    function showKeyboardHint(message) {
      keyboardHint.textContent = message;
      keyboardHint.style.display = 'block';
      setTimeout(() => {
        keyboardHint.style.display = 'none';
      }, 2000);
    }

    // Add conversation item
    function addConversationItem(speaker, text, isAI = false, isEnhanced = false) {
      const item = document.createElement('div');
      item.className = `conversation-item ${speaker}`;
      let indicator = '';
      if (isEnhanced) {
        indicator = '<span class="enhanced-indicator"><i class="fa-solid fa-brain"></i>Enhanced</span>';
      } else if (isAI) {
        indicator = '<span class="ai-indicator"><i class="fa-solid fa-robot"></i>AI</span>';
      }
      
      // Clean the text for display
      const cleanText = cleanTextForSpeech(text);
      
      item.innerHTML = `
        <div class="conversation-label">${speaker === 'user' ? 'You' : 'AI Travel Agent'}${indicator}</div>
        <div class="conversation-text">${cleanText}</div>
      `;
      conversationContainer.appendChild(item);
      conversationContainer.scrollTop = conversationContainer.scrollHeight;
      
      // Store in history
      conversationHistory.push({ speaker, text: cleanText, timestamp: new Date(), isAI, isEnhanced });
    }

    // Enhanced voice command processing with Puter.js AI
    async function processVoiceCommand(input) {
      const lowerInput = input.toLowerCase();
      
      if (lowerInput.includes('show checklist') || lowerInput.includes('open checklist')) {
        toggleChecklist();
        return "I've opened your travel checklist. You can check off items as you complete them!";
      }
      
      if (lowerInput.includes('voice commands') || lowerInput.includes('help')) {
        toggleVoiceHelp();
        return "I've shown the voice commands help. You can also press 'H' on your keyboard for quick access!";
      }
      
      if (lowerInput.includes('clear conversation') || lowerInput.includes('new conversation')) {
        clearConversation();
        return "I've cleared our conversation. We can start fresh!";
      }
      
      if (lowerInput.includes('set budget') || lowerInput.includes('my budget is')) {
        const budgetMatch = input.match(/(\d+)/);
        if (budgetMatch) {
          userPreferences.budget = parseInt(budgetMatch[1]);
          updateUserProfile();
          return `I've saved your budget of $${budgetMatch[1]}. I'll suggest destinations and options within your range.`;
        }
      }
      
      if (lowerInput.includes('travel style') || lowerInput.includes('i prefer')) {
        const styles = ['luxury', 'budget', 'adventure', 'relaxation', 'culture', 'family'];
        const foundStyle = styles.find(style => lowerInput.includes(style));
        if (foundStyle) {
          userPreferences.travelStyle = foundStyle;
          updateUserProfile();
          return `I've noted you prefer ${foundStyle} travel. I'll tailor my recommendations accordingly.`;
        }
      }
      
      if (lowerInput.includes('save destination') || lowerInput.includes('remember')) {
        const destinationMatch = input.match(/(?:save|remember)\s+([a-zA-Z\s]+)/i);
        if (destinationMatch) {
          const destination = destinationMatch[1].trim();
          if (!userPreferences.preferredDestinations.includes(destination)) {
            userPreferences.preferredDestinations.push(destination);
          }
          updateUserProfile();
          return `I've saved ${destination} to your preferred destinations.`;
        }
      }
      
      // Enhanced response system combining AI and local travel data
      try {
        // First, get local travel data response
        const localResponse = getTravelResponse(input, currentLang);
        
        // Build conversation context from recent history
        const recentHistory = conversationHistory.slice(-3).map(item => 
          `${item.speaker === 'user' ? 'User' : 'Assistant'}: ${item.text}`
        ).join('\n');
        
        // Build user preferences context
        const preferencesContext = [];
        if (userPreferences.budget) preferencesContext.push(`Budget: $${userPreferences.budget}`);
        if (userPreferences.travelStyle) preferencesContext.push(`Travel Style: ${userPreferences.travelStyle}`);
        if (userPreferences.preferredDestinations.length > 0) {
          preferencesContext.push(`Preferred Destinations: ${userPreferences.preferredDestinations.join(', ')}`);
        }
        
        // Determine language for response
        let responseLanguage = 'English';
        switch(currentLang) {
          case 'hi-IN': responseLanguage = 'Hindi'; break;
          case 'ru-RU': responseLanguage = 'Russian'; break;
          case 'ja-JP': responseLanguage = 'Japanese'; break;
          default: responseLanguage = 'English'; break;
        }
        
        const aiPrompt = `You are a helpful travel agent assistant. 
        
        User Preferences: ${preferencesContext.length > 0 ? preferencesContext.join(', ') : 'None set'}
        
        Recent conversation context:
        ${recentHistory}
        
        Current user question: "${input}"
        
        Local travel data response: "${localResponse}"
        
        IMPORTANT: Respond in ${responseLanguage} language. If the user is speaking in ${responseLanguage}, you must respond in ${responseLanguage}.
        
        Enhance the local response with detailed AI insights. Provide comprehensive information in 8-10 sentences.
        
        Include detailed information about:
        - Destination highlights and attractions
        - Pricing and budget considerations
        - Best times to visit
        - Weather and climate
        - Transportation options
        - Accommodation recommendations
        - Local customs and culture
        - Practical tips and advice
        
        If user has preferences set, provide personalized suggestions with explanations.
        
        Be friendly, detailed, and helpful. Provide the most useful travel advice possible.
        Use only plain text, no emojis or symbols, but preserve international characters for different languages.`;
        
        const response = await puter.ai.chat(aiPrompt, {model: 'claude-sonnet-4'});
        const cleanResponse = cleanAndShortenText(response.message.content[0].text);
        return cleanResponse;
      } catch (error) {
        console.error('AI response error:', error);
        // Fallback to local travel response if AI fails
        return getTravelResponse(input, currentLang);
      }
    }

    function clearConversation() {
      conversationContainer.innerHTML = `
        <div class="conversation-item bot">
          <div class="conversation-label">AI Travel Agent</div>
          <div class="conversation-text" id="welcomeMessage">Hello! I'm your AI-powered travel assistant. I can help you plan your next adventure with intelligent recommendations and personalized advice. Ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!</div>
        </div>
      `;
      conversationHistory = [];
      askResult.style.display = 'none';
      askLoading.style.display = 'none';
      
      // Update the welcome message to current language
      updateWelcomeMessage();
    }

    // Handle quick action buttons with AI enhancement
    quickButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        const actionText = btn.textContent.replace(/[🌍✈️🏨💰🌤️📋🛡️🧳]/g, '').trim();
        
        // Add user message
        addConversationItem('user', `I want to know about ${actionText.toLowerCase()}`);
        
        // Show loading state
        askLoading.textContent = 'Getting AI travel advice...';
        askLoading.style.display = '';
        
        try {
          // Get enhanced response combining AI and local data
          const response = await processVoiceCommand(`Give me brief tips about ${actionText.toLowerCase()} for travel`);
          addConversationItem('bot', response, true, true); // Mark as enhanced AI response
          
          // Speak the response
          speakResponse(response);
        } catch (error) {
          // Fallback to local travel data response
          const response = getTravelResponse(action, currentLang);
          addConversationItem('bot', response);
          speakResponse(response);
        } finally {
          askLoading.style.display = 'none';
        }
      });
    });

    // Speak response function
    function speakResponse(text) {
      if ('speechSynthesis' in window) {
        // Clean text for speech synthesis
        const speechText = cleanTextForSpeech(text);
        
        const utter = new window.SpeechSynthesisUtterance(speechText);
        utter.lang = currentLang;
        utter.onstart = () => { 
          micBtn.disabled = true; 
          statusIndicator.classList.add('recording');
        };
        utter.onend = () => { 
          micBtn.disabled = false; 
          statusIndicator.classList.remove('recording');
        };
        window.speechSynthesis.onvoiceschanged = () => {
          const voices = window.speechSynthesis.getVoices();
          utter.voice = voices.find(v => v.lang === currentLang) || null;
          window.speechSynthesis.speak(utter);
        };
        const voices = window.speechSynthesis.getVoices();
        if (voices.length) {
          utter.voice = voices.find(v => v.lang === currentLang) || null;
          window.speechSynthesis.speak(utter);
        }
      }
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = currentLang;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        recognizing = true;
        micBtn.classList.add('recording');
        statusIndicator.classList.add('recording');
        askLoading.textContent = 'Listening...';
        askLoading.style.display = '';
        askResult.style.display = 'none';
      };
      
      recognition.onend = () => {
        recognizing = false;
        micBtn.classList.remove('recording');
        statusIndicator.classList.remove('recording');
        if (!askResult.textContent) askLoading.style.display = 'none';
      };
      
      recognition.onerror = (event) => {
        recognizing = false;
        micBtn.classList.remove('recording');
        statusIndicator.classList.remove('recording');
        askLoading.textContent = 'Could not hear you. Try again!';
        setTimeout(() => askLoading.style.display = 'none', 2000);
      };
      
      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        askLoading.textContent = 'Getting AI travel advice...';
        
        // Add user message to conversation
        addConversationItem('user', transcript);
        
        try {
          // Process voice command or get AI-powered travel agent response
          const response = await processVoiceCommand(transcript);
          addConversationItem('bot', response, true, true); // Mark as enhanced AI response
          askLoading.style.display = 'none';
          askResult.style.display = '';

          // Speak the response
          speakResponse(response);
        } catch (err) {
          const errorMsg = 'Error: ' + (err?.message || err);
          addConversationItem('bot', errorMsg);
          askLoading.style.display = 'none';
        }
      };

      langSelect.addEventListener('change', () => {
        currentLang = langSelect.value;
        recognition.lang = currentLang;
        
        // Update the welcome message when language changes
        updateWelcomeMessage();
      });
    } else {
      micBtn.disabled = true;
      addConversationItem('bot', 'Sorry, your browser does not support voice input.');
    }

    micBtn.addEventListener('click', () => {
      if (recognition && !recognizing) {
        recognition.start();
      }
    });

    refreshBtn.addEventListener('click', () => {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      clearConversation();
    });

    // Event listeners for accessibility
    micBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (recognition && !recognizing) {
          recognition.start();
        }
      }
    });

    refreshBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        clearConversation();
      }
    });

    // Show keyboard hint on first load
    setTimeout(() => {
      showKeyboardHint('Press H for help, C for checklist, Space to speak');
    }, 3000);

    // Text input functionality
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    
    async function handleTextInput() {
      const text = textInput.value.trim();
      if (text) {
        // Add user message
        addConversationItem('user', text);
        
        // Show loading state
        askLoading.textContent = 'Getting AI travel advice...';
        askLoading.style.display = '';
        
        try {
          // Get enhanced response combining AI and local data
          const response = await processVoiceCommand(text);
          addConversationItem('bot', response, true, true); // Mark as enhanced AI response
        } catch (error) {
          // Fallback to local travel data response
          const response = getTravelResponse(text, currentLang);
          addConversationItem('bot', response);
        } finally {
          askLoading.style.display = 'none';
        }
        
        // Clear input
        textInput.value = '';
        
        // Focus back to input for continued conversation
        textInput.focus();
      }
    }
    
    // Handle send button click
    sendBtn.addEventListener('click', handleTextInput);
    
    // Handle Enter key in text input
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleTextInput();
      }
    });
    

      </script>
    
    <!-- Service Worker Registration for GitHub Actions -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('service-worker.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful:', registration.scope);
            })
            .catch(function(error) {
              console.log('ServiceWorker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
