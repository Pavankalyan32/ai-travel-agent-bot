<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Agent Bot - Murmu</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <script src="travel-agent-data.js"></script>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      background: #fafbfc;
      font-family: 'Inter', sans-serif;
    }
    .ask-center {
      min-height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f3f0ff 0%, #fafbfc 100%);
      padding: 20px;
    }
    .ask-title {
      color: #8b5cf6;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }
    .ask-desc {
      color: #5b6478;
      font-size: 1.25rem;
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Quick Action Buttons */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 30px;
      max-width: 600px;
    }
    .quick-btn {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    .quick-btn:active {
      transform: translateY(0);
    }
    .quick-btn:focus {
      outline: 2px solid #8b5cf6;
      outline-offset: 2px;
    }
    
    /* Travel Checklist */
    .checklist-container {
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      display: none;
    }
    .checklist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .checklist-title {
      font-weight: 600;
      color: #8b5cf6;
    }
    .checklist-toggle {
      background: none;
      border: none;
      color: #8b5cf6;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .checklist-item:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    .checklist-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    .checklist-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    /* Real-time Data Display */
    .realtime-data {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .data-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      min-width: 120px;
      text-align: center;
    }
    .data-label {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 5px;
    }
    .data-value {
      font-weight: 600;
      color: #8b5cf6;
    }
    
    .ask-mic-btn {
      background: radial-gradient(circle at 30% 30%, #a78bfa 60%, #7c3aed 100%);
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2.2rem;
      box-shadow: 0 4px 24px 0 #a78bfa33;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: pulse 1.5s infinite;
      position: relative;
    }
    .ask-mic-btn.recording {
      animation: recording-pulse 0.8s infinite;
      background: radial-gradient(circle at 30% 30%, #ef4444 60%, #dc2626 100%);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 #a78bfa55; }
      70% { box-shadow: 0 0 0 24px #a78bfa11; }
      100% { box-shadow: 0 0 0 0 #a78bfa55; }
    }
    @keyframes recording-pulse {
      0% { box-shadow: 0 0 0 0 #ef444455; transform: scale(1); }
      50% { box-shadow: 0 0 0 20px #ef444422; transform: scale(1.05); }
      100% { box-shadow: 0 0 0 0 #ef444455; transform: scale(1); }
    }
    .ask-mic-btn:active {
      transform: scale(0.95);
    }
    .ask-mic-btn i {
      transition: transform 0.2s;
    }
    .ask-mic-btn:hover i {
      transform: scale(1.2) rotate(-8deg);
    }
    .ask-mic-btn:focus {
      outline: 3px solid #8b5cf6;
      outline-offset: 3px;
    }
    
    /* Conversation History */
    .conversation-container {
      width: 100%;
      max-width: 600px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
    }
    .conversation-item {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 10px;
      animation: slideIn 0.3s ease;
    }
    .conversation-item.user {
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      margin-left: 20px;
      border-left: 4px solid #8b5cf6;
    }
    .conversation-item.bot {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      margin-right: 20px;
      border-left: 4px solid #10b981;
    }
    .conversation-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 5px;
      opacity: 0.7;
    }
    .conversation-text {
      font-size: 0.95rem;
      line-height: 1.4;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ask-result {
      margin-top: 20px;
      color: #444;
      font-size: 1.15rem;
      text-align: center;
      max-width: 600px;
      min-height: 40px;
      transition: all 0.3s ease;
      word-break: break-word;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
    }
    .ask-loading {
      margin-top: 20px;
      color: #8b5cf6;
      font-size: 1.1rem;
      text-align: center;
      font-style: italic;
      animation: fadeIn 0.5s;
      padding: 15px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 15px;
      border: 2px dashed #8b5cf6;
    }
    .ai-indicator {
      display: inline-block;
      margin-left: 8px;
      font-size: 0.8rem;
      color: #10b981;
      font-weight: 600;
    }
    .ai-indicator i {
      margin-right: 4px;
    }
    .enhanced-indicator {
      display: inline-block;
      margin-left: 8px;
      font-size: 0.8rem;
      color: #8b5cf6;
      font-weight: 600;
    }
    .enhanced-indicator i {
      margin-right: 4px;
    }
    .ask-refresh-btn {
      margin-top: 16px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #4b5563;
      font-size: 1rem;
      padding: 10px 24px;
      border-radius: 25px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .ask-refresh-btn:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .ask-refresh-btn:active {
      transform: translateY(0);
    }
    .ask-refresh-btn:focus {
      outline: 2px solid #8b5cf6;
      outline-offset: 2px;
    }
    
    /* Status indicator */
    .status-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10b981;
      border: 3px solid white;
      animation: status-pulse 2s infinite;
    }
    .status-indicator.recording {
      background: #ef4444;
      animation: status-recording 0.8s infinite;
    }
    @keyframes status-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes status-recording {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.2); }
    }
    
    /* Voice Commands Help */
    .voice-help {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.2);
      backdrop-filter: blur(10px);
      max-width: 300px;
      display: none;
      z-index: 1000;
    }
    .voice-help h4 {
      margin: 0 0 10px 0;
      color: #8b5cf6;
    }
    .voice-command {
      margin: 5px 0;
      font-size: 0.9rem;
    }
    .voice-command strong {
      color: #8b5cf6;
    }
    
    /* Keyboard shortcuts */
    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      display: none;
    }
    
    @media (max-width: 700px) {
      .ask-title { font-size: 2rem; }
      .ask-desc { font-size: 1rem; }
      .ask-mic-btn { width: 70px; height: 70px; font-size: 1.5rem; }
      .ask-result, .ask-loading { font-size: 1rem; }
      .quick-actions { gap: 8px; }
      .quick-btn { font-size: 0.8rem; padding: 6px 12px; }
      .conversation-container { max-height: 250px; }
      .realtime-data { gap: 8px; }
      .data-card { min-width: 100px; }
    }
  </style>
</head>
<body>
  <div class="ask-center">
    <div class="ask-title">Murmu</div>
    <div class="ask-desc">AI-powered travel assistant - Ask me about destinations, flights, hotels, and travel tips</div>
    
    <!-- Real-time Data Display -->
    <div class="realtime-data" id="realtimeData">
      <div class="data-card">
        <div class="data-label">Weather</div>
        <div class="data-value" id="weatherData">Loading...</div>
      </div>
      <div class="data-card">
        <div class="data-label">USD/EUR</div>
        <div class="data-value" id="currencyData">Loading...</div>
      </div>
      <div class="data-card">
        <div class="data-label">Flight Deals</div>
        <div class="data-value" id="flightData">Loading...</div>
      </div>
      <div class="data-card" id="userProfileCard" style="display: none;">
        <div class="data-label">Your Profile</div>
        <div class="data-value" id="userProfileData">Set preferences</div>
      </div>
    </div>
    
    <!-- Travel Checklist -->
    <div class="checklist-container" id="checklistContainer">
      <div class="checklist-header">
        <div class="checklist-title">Travel Checklist</div>
        <button class="checklist-toggle" id="checklistToggle">×</button>
      </div>
      <div id="checklistItems">
        <div class="checklist-item">
          <input type="checkbox" id="check1">
          <label for="check1">Passport and visa documents</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check2">
          <label for="check2">Travel insurance</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check3">
          <label for="check3">Flight tickets</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check4">
          <label for="check4">Hotel reservations</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check5">
          <label for="check5">Currency exchange</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check6">
          <label for="check6">Packing essentials</label>
        </div>
      </div>
    </div>
    
    <!-- Quick Action Buttons -->
    <div class="quick-actions">
      <button class="quick-btn" data-action="destinations">🌍 Destinations</button>
      <button class="quick-btn" data-action="flights">✈️ Flights</button>
      <button class="quick-btn" data-action="hotels">🏨 Hotels</button>
      <button class="quick-btn" data-action="budget">💰 Budget</button>
      <button class="quick-btn" data-action="weather">🌤️ Weather</button>
      <button class="quick-btn" data-action="visa">📋 Visa</button>
      <button class="quick-btn" data-action="insurance">🛡️ Insurance</button>
      <button class="quick-btn" data-action="packing">🧳 Packing</button>
      <button class="quick-btn" data-action="recommendations">💡 Smart Recommendations</button>
    </div>
    
    <select id="langSelect" style="margin-bottom:20px; padding:8px 18px; border-radius:8px; border:1px solid #e5e7eb; font-size:1rem; font-family:inherit; outline:none; background:white;">
      <option value="en-US">English</option>
      <option value="hi-IN">हिन्दी</option>
      <option value="ru-RU">Русский</option>
      <option value="ja-JP">日本語</option>
    </select>
    
    <button class="ask-mic-btn" id="micBtn" tabindex="0">
      <i class="fa-solid fa-microphone"></i>
      <div class="status-indicator" id="statusIndicator"></div>
    </button>
    
    <!-- Text Input for Manual Entry -->
    <div id="textInputContainer" style="margin:20px 0; width:100%; max-width:400px;">
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" id="textInput" placeholder="Type your travel question..." 
               style="flex:1; padding:12px 16px; border:2px solid #e5e7eb; border-radius:25px; font-size:1rem; outline:none; transition:border-color 0.3s;">
        <button id="sendBtn" style="padding:12px 20px; background:#8b5cf6; color:white; border:none; border-radius:25px; cursor:pointer; font-size:1rem;">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
    
    <!-- Conversation History -->
    <div class="conversation-container" id="conversationContainer">
      <div class="conversation-item bot">
        <div class="conversation-label">AI Travel Agent</div>
        <div class="conversation-text" id="welcomeMessage">Hello! I'm your AI-powered travel assistant. I can help you plan your next adventure with intelligent recommendations and personalized advice. Ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!</div>
      </div>
    </div>
    
    <div id="askLoading" class="ask-loading" style="display:none;">
      <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i>
      Listening...
    </div>
    <div id="askResult" class="ask-result" style="display:none;"></div>
    
    <button class="ask-refresh-btn" id="refreshBtn" tabindex="0">
      <i class="fa-solid fa-rotate-right" style="margin-right:6px;"></i> New Conversation
    </button>
    
    <button class="ask-refresh-btn" id="testAiBtn" tabindex="0" style="margin-left:10px; background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
      <i class="fa-solid fa-robot" style="margin-right:6px;"></i> Test Ollama
    </button>
  </div>

  <!-- Voice Commands Help -->
  <div class="voice-help" id="voiceHelp">
    <h4>Voice Commands</h4>
    <div class="voice-command"><strong>"Show checklist"</strong> - Open travel checklist</div>
    <div class="voice-command"><strong>"Voice commands"</strong> - Show this help</div>
    <div class="voice-command"><strong>"Set budget [amount]"</strong> - Save your budget</div>
    <div class="voice-command"><strong>"I prefer [style]"</strong> - Set travel style</div>
    <div class="voice-command"><strong>"Save destination [name]"</strong> - Remember destination</div>
    <div class="voice-command"><strong>"Clear conversation"</strong> - Start fresh</div>
  </div>

  <!-- Keyboard Shortcuts Hint -->
  <div class="keyboard-hint" id="keyboardHint">
    Press 'H' for voice commands help, 'C' for checklist, 'Space' to speak
  </div>

  <script>
    const micBtn = document.getElementById('micBtn');
    const askResult = document.getElementById('askResult');
    const askLoading = document.getElementById('askLoading');
    const langSelect = document.getElementById('langSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const conversationContainer = document.getElementById('conversationContainer');
    const statusIndicator = document.getElementById('statusIndicator');
    const quickButtons = document.querySelectorAll('.quick-btn');
    const checklistContainer = document.getElementById('checklistContainer');
    const checklistToggle = document.getElementById('checklistToggle');
    const voiceHelp = document.getElementById('voiceHelp');
    const keyboardHint = document.getElementById('keyboardHint');
    const realtimeData = document.getElementById('realtimeData');
    
    let recognizing = false;
    let recognition;
    let currentLang = langSelect.value;
    let conversationHistory = [];
    let isChecklistVisible = false;
    let isVoiceHelpVisible = false;
    
    // User preferences and travel profile
    let userPreferences = {
      budget: null,
      travelStyle: null,
      preferredDestinations: [],
      interests: [],
      accessibility: false,
      familyTravel: false
    };

    // Function to clean text for speech synthesis
    function cleanTextForSpeech(text) {
      if (!text) return '';
      
      // Remove emojis and special symbols but preserve international characters
      let cleaned = text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
      
      // Remove bullet points and list markers
      cleaned = cleaned.replace(/^[\s•\-\*]+/gm, '');
      cleaned = cleaned.replace(/^\d+\.\s*/gm, '');
      
      // Clean up spacing but preserve international characters
      cleaned = cleaned.replace(/\s+/g, ' ');
      cleaned = cleaned.replace(/\s+([.,!?])/g, '$1');
      
      return cleaned.trim();
    }

    // Text cleaning and shortening function
    function cleanAndShortenText(text) {
      if (!text) return '';
      
      // Remove extra whitespace and normalize
      let cleaned = text.replace(/\s+/g, ' ').trim();
      
      // Remove emojis and special symbols but preserve international characters
      cleaned = cleaned.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
      
      // Remove common AI artifacts and formal language
      cleaned = cleaned.replace(/^(Here's|Here is|I'll|I will|Let me|Based on|According to|I can|I would|I'd)/gi, '');
      cleaned = cleaned.replace(/(\.|,|!|\?)\s*(Here's|Here is|I'll|I will|Let me|Based on|According to|I can|I would|I'd)/gi, '$1');
      
      // Remove redundant phrases
      cleaned = cleaned.replace(/\b(please note that|it's worth noting that|it's important to|keep in mind that|remember that)\b/gi, '');
      cleaned = cleaned.replace(/\b(in terms of|when it comes to|as far as|regarding|concerning)\b/gi, '');
      
      // Remove bullet points and list markers
      cleaned = cleaned.replace(/^[\s•\-\*]+/gm, '');
      cleaned = cleaned.replace(/^\d+\.\s*/gm, '');
      
      // Shorten long sentences by breaking at natural points
      const sentences = cleaned.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const shortSentences = sentences.map(sentence => {
        let short = sentence.trim();
        
        // Allow longer sentences for detailed responses
        if (short.length > 150) {
          const parts = short.split(/[,;]/);
          if (parts.length > 1) {
            short = parts[0].trim();
          }
        }
        
        // Keep all content for maximum detail
        // Only remove the most redundant words
        short = short.replace(/\b(very|really|quite|extremely|absolutely)\b/gi, '');
        
        return short;
      });
      
      // Limit to 10 sentences for detailed but manageable responses
      const finalSentences = shortSentences.slice(0, 10);
      
      // Join and clean up
      let result = finalSentences.join('. ').trim();
      if (!result.endsWith('.') && !result.endsWith('!') && !result.endsWith('?')) {
        result += '.';
      }
      
      // Final cleanup
      result = result.replace(/\.+/g, '.');
      result = result.replace(/\s+/g, ' ');
      result = result.replace(/\s+([.,!?])/g, '$1'); // Remove spaces before punctuation
      
      return result;
    }





    // Real-time Data Simulation
    function updateRealtimeData() {
      const weatherData = document.getElementById('weatherData');
      const currencyData = document.getElementById('currencyData');
      const flightData = document.getElementById('flightData');
      
      // Simulate real-time updates
      const weatherConditions = ['☀️ 72°F', '🌤️ 68°F', '⛅ 75°F', '🌧️ 65°F'];
      const currencyRates = ['$1.08', '$1.12', '$1.05', '$1.15'];
      const flightDeals = ['$299', '$349', '$399', '$449'];
      
      weatherData.textContent = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
      currencyData.textContent = currencyRates[Math.floor(Math.random() * currencyRates.length)];
      flightData.textContent = flightDeals[Math.floor(Math.random() * flightDeals.length)];
    }

    // Update data every 30 seconds
    setInterval(updateRealtimeData, 30000);
    updateRealtimeData();
    
    // Test function to verify language preservation
    function testLanguagePreservation() {
      const testTexts = {
        'Hindi': 'नमस्ते! मैं आपका व्यक्तिगत ट्रैवल एजेंट हूं।',
        'Russian': 'Привет! Я ваш персональный туристический агент.',
        'Japanese': 'こんにちは！私はあなたのパーソナル旅行代理店です。',
        'English': 'Hello! I am your personal travel agent.'
      };
      
      console.log('Testing language preservation:');
      Object.entries(testTexts).forEach(([lang, text]) => {
        const cleaned = cleanTextForSpeech(text);
        console.log(`${lang}: ${cleaned}`);
      });
    }
    
    // Run test on page load
    testLanguagePreservation();
    
    // Test Ollama availability
    setTimeout(async () => {
      console.log('=== OLLAMA DEBUGGING ===');
      console.log('Checking Ollama availability...');
      
      try {
        const testResponse = await callOllamaAI('Say "Hello, Ollama is working!"', 'llama3.1:8b');
        console.log('✅ Ollama test successful:', testResponse);
      } catch (error) {
        console.error('❌ Ollama test failed:', error);
        console.log('Make sure Ollama is installed and running on localhost:11434');
        console.log('Install Ollama from: https://ollama.ai/');
        console.log('Then run: ollama pull llama3.1:8b');
      }
    }, 2000);
    
    // Ollama AI integration function
    async function callOllamaAI(prompt, model = 'llama3.1:8b') {
      try {
        console.log(`Calling Ollama with model: ${model}`);
        console.log('Prompt:', prompt);
        
        const response = await fetch('http://localhost:11434/api/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: model,
            prompt: prompt,
            stream: false,
            options: {
              temperature: 0.7,
              top_p: 0.9,
              max_tokens: 500
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Ollama response:', data);
        
        if (data.response) {
          return data.response;
        } else {
          throw new Error('No response from Ollama');
        }
      } catch (error) {
        console.error('Ollama API error:', error);
        throw error;
      }
    }

    // Enhanced local response function for when AI is not available
    function getEnhancedLocalResponse(input, lang) {
      const lowerInput = input.toLowerCase();
      
      // Hindi responses
      if (lang === 'hi-IN') {
        if (lowerInput.includes('लाल किला') || lowerInput.includes('red fort')) {
          return 'लाल किला दिल्ली का प्रसिद्ध ऐतिहासिक स्मारक है। यह मुगल वास्तुकला का शानदार उदाहरण है। यहां जाने का सबसे अच्छा समय अक्टूबर से मार्च है। प्रवेश शुल्क भारतीय नागरिकों के लिए 35 रुपये और विदेशी पर्यटकों के लिए 500 रुपये है। सुबह 9 बजे से शाम 5 बजे तक खुला रहता है। सोमवार को बंद रहता है। मेट्रो से जाने के लिए चांदनी चौक स्टेशन उतरें।';
        }
        if (lowerInput.includes('ताज महल') || lowerInput.includes('taj mahal')) {
          return 'ताज महल आगरा में स्थित विश्व के सात अजूबों में से एक है। यह सफेद संगमरमर से बना है और प्रेम का प्रतीक है। सबसे अच्छा समय सूर्योदय और सूर्यास्त के समय है। प्रवेश शुल्क भारतीय नागरिकों के लिए 50 रुपये और विदेशी पर्यटकों के लिए 1100 रुपये है। शुक्रवार को बंद रहता है। आगरा किला भी देखना न भूलें।';
        }
        if (lowerInput.includes('गोवा') || lowerInput.includes('goa')) {
          return 'गोवा भारत का सबसे लोकप्रिय समुद्र तटीय राज्य है। यहां सुंदर समुद्र तट, पुर्तगाली वास्तुकला और स्वादिष्ट भोजन मिलता है। नवंबर से मार्च सबसे अच्छा समय है। होटल की कीमत 2000-8000 रुपये प्रति रात है। पणजी, कैंडोलिम और बागा समुद्र तट देखें। स्थानीय भोजन और समुद्री भोजन जरूर खाएं।';
        }
        return getTravelResponse(input, lang);
      }
      
      // Russian responses
      if (lang === 'ru-RU') {
        if (lowerInput.includes('москва') || lowerInput.includes('moscow')) {
          return 'Москва - столица России и один из самых красивых городов мира. Красная площадь, Кремль и собор Василия Блаженного - главные достопримечательности. Лучшее время для посещения - май-сентябрь. Стоимость отелей от 3000 до 15000 рублей за ночь. Обязательно посетите Третьяковскую галерею и парк Горького.';
        }
        if (lowerInput.includes('санкт-петербург') || lowerInput.includes('st petersburg')) {
          return 'Санкт-Петербург - культурная столица России. Эрмитаж, Петергоф и Исаакиевский собор - основные достопримечательности. Лучшее время - июнь-август для белых ночей. Стоимость проживания от 2500 до 12000 рублей. Обязательно совершите прогулку по каналам.';
        }
        return getTravelResponse(input, lang);
      }
      
      // Japanese responses
      if (lang === 'ja-JP') {
        if (lowerInput.includes('東京') || lowerInput.includes('tokyo')) {
          return '東京は日本の首都で、世界最大の都市の一つです。浅草寺、東京スカイツリー、渋谷スクランブル交差点が人気の観光スポットです。春（桜）と秋（紅葉）が最も美しい季節です。ホテル代は1泊8000円から30000円です。電車と地下鉄が便利です。';
        }
        if (lowerInput.includes('京都') || lowerInput.includes('kyoto')) {
          return '京都は日本の古都で、多くの寺院と神社があります。金閣寺、清水寺、伏見稲荷大社が有名です。春と秋が最も美しい季節です。ホテル代は1泊6000円から25000円です。着物を着て散策することをお勧めします。';
        }
        return getTravelResponse(input, lang);
      }
      
      // English responses (enhanced)
      if (lowerInput.includes('paris') || lowerInput.includes('france')) {
        return 'Paris is the romantic capital of France, famous for the Eiffel Tower, Louvre Museum, and Notre-Dame Cathedral. Best time to visit is April-June or September-October. Hotel prices range from $150-500 per night. Must-see attractions include the Arc de Triomphe, Champs-Élysées, and Montmartre. Try local cuisine like croissants, escargot, and French wine.';
      }
      if (lowerInput.includes('london') || lowerInput.includes('england')) {
        return 'London is the historic capital of England, home to Big Ben, Buckingham Palace, and the Tower of London. Best time to visit is March-May or September-November. Hotel prices range from $200-600 per night. Don\'t miss the British Museum, Westminster Abbey, and a ride on the London Eye. Try traditional fish and chips and afternoon tea.';
      }
      if (lowerInput.includes('new york') || lowerInput.includes('nyc')) {
        return 'New York City is the vibrant metropolis of the USA, famous for Times Square, Statue of Liberty, and Central Park. Best time to visit is April-June or September-November. Hotel prices range from $250-800 per night. Must-see attractions include Broadway shows, Empire State Building, and Brooklyn Bridge. Try New York pizza and bagels.';
      }
      if (lowerInput.includes('tokyo') || lowerInput.includes('japan')) {
        return 'Tokyo is Japan\'s bustling capital, known for its modern technology and traditional culture. Best time to visit is March-May for cherry blossoms or October-November for autumn colors. Hotel prices range from $100-400 per night. Visit Senso-ji Temple, Tokyo Skytree, and Shibuya Crossing. Try sushi, ramen, and tempura.';
      }
      
      return getTravelResponse(input, lang);
    }

    // Function to update welcome message based on current language
    function updateWelcomeMessage() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      const welcomeMessages = {
        'en-US': 'Hello! I\'m your AI-powered travel assistant. I can help you plan your next adventure with intelligent recommendations and personalized advice. Ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!',
        'hi-IN': 'नमस्ते! मैं आपका AI-संचालित यात्रा सहायक हूं। मैं आपकी अगली यात्रा की योजना बनाने में मदद कर सकता हूं। मुझसे गंतव्य, उड़ानें, होटल और यात्रा टिप्स के बारे में पूछें!',
        'ru-RU': 'Привет! Я ваш ИИ-ассистент для путешествий. Я могу помочь спланировать ваше следующее приключение с умными рекомендациями. Спросите меня о направлениях, рейсах, отелях и советах по путешествиям!',
        'ja-JP': 'こんにちは！私はあなたのAI旅行アシスタントです。次回の冒険を計画するお手伝いができます。目的地、フライト、ホテル、旅行のヒントについてお聞きください！'
      };
      if (welcomeMessage) {
        welcomeMessage.textContent = welcomeMessages[currentLang] || welcomeMessages['en-US'];
      }
    }
    
    // Update welcome message on page load
    updateWelcomeMessage();
    
    // Function to update user profile display
    function updateUserProfile() {
      const userProfileCard = document.getElementById('userProfileCard');
      const userProfileData = document.getElementById('userProfileData');
      
      if (userPreferences.budget || userPreferences.travelStyle || userPreferences.preferredDestinations.length > 0) {
        userProfileCard.style.display = 'block';
        const profileInfo = [];
        if (userPreferences.budget) profileInfo.push(`$${userPreferences.budget}`);
        if (userPreferences.travelStyle) profileInfo.push(userPreferences.travelStyle);
        if (userPreferences.preferredDestinations.length > 0) {
          profileInfo.push(userPreferences.preferredDestinations[0]);
        }
        userProfileData.textContent = profileInfo.join(', ');
      } else {
        userProfileCard.style.display = 'none';
      }
    }

    // Checklist functionality
    function toggleChecklist() {
      isChecklistVisible = !isChecklistVisible;
      checklistContainer.style.display = isChecklistVisible ? 'block' : 'none';
    }

    // Voice commands help
    function toggleVoiceHelp() {
      isVoiceHelpVisible = !isVoiceHelpVisible;
      voiceHelp.style.display = isVoiceHelpVisible ? 'block' : 'none';
    }

    // Handle checklist item completion
    document.querySelectorAll('#checklistItems input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const item = this.closest('.checklist-item');
        if (this.checked) {
          item.classList.add('completed');
        } else {
          item.classList.remove('completed');
        }
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'h' || e.key === 'H') {
        toggleVoiceHelp();
        showKeyboardHint('Voice commands help toggled');
      } else if (e.key === 'c' || e.key === 'C') {
        toggleChecklist();
        showKeyboardHint('Checklist toggled');
      } else if (e.key === ' ' && !recognizing) {
        e.preventDefault();
        if (recognition) recognition.start();
      }
    });

    function showKeyboardHint(message) {
      keyboardHint.textContent = message;
      keyboardHint.style.display = 'block';
      setTimeout(() => {
        keyboardHint.style.display = 'none';
      }, 2000);
    }

    // Add conversation item
    function addConversationItem(speaker, text, isAI = false, isEnhanced = false) {
      const item = document.createElement('div');
      item.className = `conversation-item ${speaker}`;
      let indicator = '';
      if (isEnhanced) {
        indicator = '<span class="enhanced-indicator"><i class="fa-solid fa-brain"></i>Enhanced</span>';
      } else if (isAI) {
        indicator = '<span class="ai-indicator"><i class="fa-solid fa-robot"></i>AI</span>';
      }
      
      // Clean the text for display
      const cleanText = cleanTextForSpeech(text);
      
      item.innerHTML = `
        <div class="conversation-label">${speaker === 'user' ? 'You' : 'AI Travel Agent'}${indicator}</div>
        <div class="conversation-text">${cleanText}</div>
      `;
      conversationContainer.appendChild(item);
      conversationContainer.scrollTop = conversationContainer.scrollHeight;
      
      // Store in history
      conversationHistory.push({ speaker, text: cleanText, timestamp: new Date(), isAI, isEnhanced });
    }

    // Enhanced voice command processing with Puter.js AI
    async function processVoiceCommand(input) {
      const lowerInput = input.toLowerCase();
      
      if (lowerInput.includes('show checklist') || lowerInput.includes('open checklist')) {
        toggleChecklist();
        return "I've opened your travel checklist. You can check off items as you complete them!";
      }
      
      if (lowerInput.includes('voice commands') || lowerInput.includes('help')) {
        toggleVoiceHelp();
        return "I've shown the voice commands help. You can also press 'H' on your keyboard for quick access!";
      }
      
      if (lowerInput.includes('clear conversation') || lowerInput.includes('new conversation')) {
        clearConversation();
        return "I've cleared our conversation. We can start fresh!";
      }
      
      if (lowerInput.includes('set budget') || lowerInput.includes('my budget is')) {
        const budgetMatch = input.match(/(\d+)/);
        if (budgetMatch) {
          userPreferences.budget = parseInt(budgetMatch[1]);
          updateUserProfile();
          return `I've saved your budget of $${budgetMatch[1]}. I'll suggest destinations and options within your range.`;
        }
      }
      
      if (lowerInput.includes('travel style') || lowerInput.includes('i prefer')) {
        const styles = ['luxury', 'budget', 'adventure', 'relaxation', 'culture', 'family'];
        const foundStyle = styles.find(style => lowerInput.includes(style));
        if (foundStyle) {
          userPreferences.travelStyle = foundStyle;
          updateUserProfile();
          return `I've noted you prefer ${foundStyle} travel. I'll tailor my recommendations accordingly.`;
        }
      }
      
      if (lowerInput.includes('save destination') || lowerInput.includes('remember')) {
        const destinationMatch = input.match(/(?:save|remember)\s+([a-zA-Z\s]+)/i);
        if (destinationMatch) {
          const destination = destinationMatch[1].trim();
          if (!userPreferences.preferredDestinations.includes(destination)) {
            userPreferences.preferredDestinations.push(destination);
          }
          updateUserProfile();
          return `I've saved ${destination} to your preferred destinations.`;
        }
      }
      
      // Enhanced response system combining Ollama AI and local travel data
      try {
        // First, get local travel data response
        const localResponse = getTravelResponse(input, currentLang);
        
        // Build conversation context from recent history
        const recentHistory = conversationHistory.slice(-3).map(item => 
          `${item.speaker === 'user' ? 'User' : 'Assistant'}: ${item.text}`
        ).join('\n');
        
        // Build user preferences context
        const preferencesContext = [];
        if (userPreferences.budget) preferencesContext.push(`Budget: $${userPreferences.budget}`);
        if (userPreferences.travelStyle) preferencesContext.push(`Travel Style: ${userPreferences.travelStyle}`);
        if (userPreferences.preferredDestinations.length > 0) {
          preferencesContext.push(`Preferred Destinations: ${userPreferences.preferredDestinations.join(', ')}`);
        }
        
        // Determine language for response
        let responseLanguage = 'English';
        switch(currentLang) {
          case 'hi-IN': responseLanguage = 'Hindi'; break;
          case 'ru-RU': responseLanguage = 'Russian'; break;
          case 'ja-JP': responseLanguage = 'Japanese'; break;
          default: responseLanguage = 'English'; break;
        }
        
        const aiPrompt = `You are a helpful travel agent assistant. 

User question: "${input}"
Local travel response: "${localResponse}"
User preferences: ${preferencesContext.length > 0 ? preferencesContext.join(', ') : 'None'}

Recent conversation:
${recentHistory}

Instructions: Respond in ${responseLanguage} language. Provide helpful travel advice in 5-8 sentences. Include destination info, pricing, best times to visit, and practical tips. Be friendly and detailed.`;

        console.log('Sending Ollama prompt:', aiPrompt);
        
        // Try different Ollama models
        const models = ['llama3.1:8b', 'mistral:7b', 'llama3.1:3b', 'llama2:7b'];
        let aiResponse = null;
        
        for (const model of models) {
          try {
            console.log(`Trying Ollama model: ${model}`);
            aiResponse = await callOllamaAI(aiPrompt, model);
            console.log(`✅ Success with Ollama model: ${model}`);
            break;
          } catch (modelError) {
            console.log(`❌ Failed with Ollama model ${model}:`, modelError);
            if (model === models[models.length - 1]) {
              throw modelError; // Re-throw if all models fail
            }
          }
        }
        
        if (aiResponse) {
          const cleanResponse = cleanAndShortenText(aiResponse);
          console.log('Cleaned Ollama response:', cleanResponse);
          return cleanResponse;
        } else {
          throw new Error('No response from any Ollama model');
        }
      } catch (error) {
        console.error('Ollama AI response error:', error);
        // Fallback to enhanced local response
        const fallbackResponse = getEnhancedLocalResponse(input, currentLang);
        console.log('Using enhanced fallback response:', fallbackResponse);
        return fallbackResponse;
      }
    }

    function clearConversation() {
      conversationContainer.innerHTML = `
        <div class="conversation-item bot">
          <div class="conversation-label">AI Travel Agent</div>
          <div class="conversation-text" id="welcomeMessage">Hello! I'm your AI-powered travel assistant. I can help you plan your next adventure with intelligent recommendations and personalized advice. Ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!</div>
        </div>
      `;
      conversationHistory = [];
      askResult.style.display = 'none';
      askLoading.style.display = 'none';
      
      // Update the welcome message to current language
      updateWelcomeMessage();
    }

    // Handle quick action buttons with AI enhancement
    quickButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        const actionText = btn.textContent.replace(/[🌍✈️🏨💰🌤️📋🛡️🧳]/g, '').trim();
        
        // Add user message
        addConversationItem('user', `I want to know about ${actionText.toLowerCase()}`);
        
        // Show loading state
        askLoading.textContent = 'Getting AI travel advice...';
        askLoading.style.display = '';
        
        try {
          // Get enhanced response combining AI and local data
          const response = await processVoiceCommand(`Give me brief tips about ${actionText.toLowerCase()} for travel`);
          addConversationItem('bot', response, true, true); // Mark as enhanced AI response
          
          // Speak the response
          speakResponse(response);
        } catch (error) {
          // Fallback to local travel data response
          const response = getTravelResponse(action, currentLang);
          addConversationItem('bot', response);
          speakResponse(response);
        } finally {
          askLoading.style.display = 'none';
        }
      });
    });

    // Speak response function
    function speakResponse(text) {
      if ('speechSynthesis' in window) {
        // Clean text for speech synthesis
        const speechText = cleanTextForSpeech(text);
        
        const utter = new window.SpeechSynthesisUtterance(speechText);
        utter.lang = currentLang;
        utter.onstart = () => { 
          micBtn.disabled = true; 
          statusIndicator.classList.add('recording');
        };
        utter.onend = () => { 
          micBtn.disabled = false; 
          statusIndicator.classList.remove('recording');
        };
        window.speechSynthesis.onvoiceschanged = () => {
          const voices = window.speechSynthesis.getVoices();
          utter.voice = voices.find(v => v.lang === currentLang) || null;
          window.speechSynthesis.speak(utter);
        };
        const voices = window.speechSynthesis.getVoices();
        if (voices.length) {
          utter.voice = voices.find(v => v.lang === currentLang) || null;
          window.speechSynthesis.speak(utter);
        }
      }
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = currentLang;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        recognizing = true;
        micBtn.classList.add('recording');
        statusIndicator.classList.add('recording');
        askLoading.textContent = 'Listening...';
        askLoading.style.display = '';
        askResult.style.display = 'none';
      };
      
      recognition.onend = () => {
        recognizing = false;
        micBtn.classList.remove('recording');
        statusIndicator.classList.remove('recording');
        if (!askResult.textContent) askLoading.style.display = 'none';
      };
      
      recognition.onerror = (event) => {
        recognizing = false;
        micBtn.classList.remove('recording');
        statusIndicator.classList.remove('recording');
        askLoading.textContent = 'Could not hear you. Try again!';
        setTimeout(() => askLoading.style.display = 'none', 2000);
      };
      
      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        askLoading.textContent = 'Getting AI travel advice...';
        
        // Add user message to conversation
        addConversationItem('user', transcript);
        
        try {
          // Process voice command or get AI-powered travel agent response
          const response = await processVoiceCommand(transcript);
          addConversationItem('bot', response, true, true); // Mark as enhanced AI response
          askLoading.style.display = 'none';
          askResult.style.display = '';

          // Speak the response
          speakResponse(response);
        } catch (err) {
          const errorMsg = 'Error: ' + (err?.message || err);
          addConversationItem('bot', errorMsg);
          askLoading.style.display = 'none';
        }
      };

      langSelect.addEventListener('change', () => {
        currentLang = langSelect.value;
        recognition.lang = currentLang;
        
        // Update the welcome message when language changes
        updateWelcomeMessage();
      });
    } else {
      micBtn.disabled = true;
      addConversationItem('bot', 'Sorry, your browser does not support voice input.');
    }

    micBtn.addEventListener('click', () => {
      if (recognition && !recognizing) {
        recognition.start();
      }
    });

    refreshBtn.addEventListener('click', () => {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      clearConversation();
    });
    
        // Test AI button
    const testAiBtn = document.getElementById('testAiBtn');
    testAiBtn.addEventListener('click', async () => {
      console.log('Testing Ollama AI manually...');
      addConversationItem('user', 'Testing Ollama AI connection...');
      
      try {
        const testResponse = await callOllamaAI('Say "AI is working!" in one sentence.', 'llama3.1:8b');
        console.log('Manual Ollama test response:', testResponse);
        
        if (testResponse) {
          addConversationItem('bot', `✅ Ollama AI Test Successful: ${testResponse}`, true, true);
        } else {
          addConversationItem('bot', '❌ Ollama responded but with empty response.');
        }
      } catch (error) {
        console.error('Manual Ollama test failed:', error);
        console.error('Error type:', typeof error);
        console.error('Error keys:', Object.keys(error || {}));
        console.error('Error message:', error?.message);
        console.error('Error stack:', error?.stack);
        addConversationItem('bot', `❌ Ollama Test Failed: ${error.message || 'Unknown error'}. Make sure Ollama is running on localhost:11434`);
      }
    });

    // Event listeners for accessibility
    micBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (recognition && !recognizing) {
          recognition.start();
        }
      }
    });

    refreshBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        clearConversation();
      }
    });

    // Show keyboard hint on first load
    setTimeout(() => {
      showKeyboardHint('Press H for help, C for checklist, Space to speak');
    }, 3000);

    // Text input functionality
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    
    async function handleTextInput() {
      const text = textInput.value.trim();
      if (text) {
        // Add user message
        addConversationItem('user', text);
        
        // Show loading state
        askLoading.textContent = 'Getting AI travel advice...';
        askLoading.style.display = '';
        
        try {
          // Get enhanced response combining AI and local data
          const response = await processVoiceCommand(text);
          addConversationItem('bot', response, true, true); // Mark as enhanced AI response
        } catch (error) {
          // Fallback to local travel data response
          const response = getTravelResponse(text, currentLang);
          addConversationItem('bot', response);
        } finally {
          askLoading.style.display = 'none';
        }
        
        // Clear input
        textInput.value = '';
        
        // Focus back to input for continued conversation
        textInput.focus();
      }
    }
    
    // Handle send button click
    sendBtn.addEventListener('click', handleTextInput);
    
    // Handle Enter key in text input
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleTextInput();
      }
    });
    

      </script>
    
    <!-- Service Worker Registration for GitHub Actions -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('service-worker.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful:', registration.scope);
            })
            .catch(function(error) {
              console.log('ServiceWorker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
