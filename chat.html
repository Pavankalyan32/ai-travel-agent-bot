<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Agent Bot - Murmu</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://js.puter.com/v2/"></script>
  <script src="travel-agent-data.js"></script>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      background: #fafbfc;
      font-family: 'Inter', sans-serif;
    }
    .ask-center {
      min-height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f3f0ff 0%, #fafbfc 100%);
      padding: 20px;
    }
    .ask-title {
      color: #8b5cf6;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
    }
    .ask-desc {
      color: #5b6478;
      font-size: 1.25rem;
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Quick Action Buttons */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 30px;
      max-width: 600px;
    }
    .quick-btn {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    .quick-btn:active {
      transform: translateY(0);
    }
    .quick-btn:focus {
      outline: 2px solid #8b5cf6;
      outline-offset: 2px;
    }
    
    /* Travel Checklist */
    .checklist-container {
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      display: none;
    }
    .checklist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .checklist-title {
      font-weight: 600;
      color: #8b5cf6;
    }
    .checklist-toggle {
      background: none;
      border: none;
      color: #8b5cf6;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .checklist-item:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    .checklist-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    .checklist-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    /* Real-time Data Display */
    .realtime-data {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .data-card {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      min-width: 120px;
      text-align: center;
    }
    .data-label {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 5px;
    }
    .data-value {
      font-weight: 600;
      color: #8b5cf6;
    }
    
    .ask-mic-btn {
      background: radial-gradient(circle at 30% 30%, #a78bfa 60%, #7c3aed 100%);
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2.2rem;
      box-shadow: 0 4px 24px 0 #a78bfa33;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: pulse 1.5s infinite;
      position: relative;
    }
    .ask-mic-btn.recording {
      animation: recording-pulse 0.8s infinite;
      background: radial-gradient(circle at 30% 30%, #ef4444 60%, #dc2626 100%);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 #a78bfa55; }
      70% { box-shadow: 0 0 0 24px #a78bfa11; }
      100% { box-shadow: 0 0 0 0 #a78bfa55; }
    }
    @keyframes recording-pulse {
      0% { box-shadow: 0 0 0 0 #ef444455; transform: scale(1); }
      50% { box-shadow: 0 0 0 20px #ef444422; transform: scale(1.05); }
      100% { box-shadow: 0 0 0 0 #ef444455; transform: scale(1); }
    }
    .ask-mic-btn:active {
      transform: scale(0.95);
    }
    .ask-mic-btn i {
      transition: transform 0.2s;
    }
    .ask-mic-btn:hover i {
      transform: scale(1.2) rotate(-8deg);
    }
    .ask-mic-btn:focus {
      outline: 3px solid #8b5cf6;
      outline-offset: 3px;
    }
    
    /* Conversation History */
    .conversation-container {
      width: 100%;
      max-width: 600px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
    }
    .conversation-item {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 10px;
      animation: slideIn 0.3s ease;
    }
    .conversation-item.user {
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      margin-left: 20px;
      border-left: 4px solid #8b5cf6;
    }
    .conversation-item.bot {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      margin-right: 20px;
      border-left: 4px solid #10b981;
    }
    .conversation-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 5px;
      opacity: 0.7;
    }
    .conversation-text {
      font-size: 0.95rem;
      line-height: 1.4;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ask-result {
      margin-top: 20px;
      color: #444;
      font-size: 1.15rem;
      text-align: center;
      max-width: 600px;
      min-height: 40px;
      transition: all 0.3s ease;
      word-break: break-word;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      border: 1px solid rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
    }
    .ask-loading {
      margin-top: 20px;
      color: #8b5cf6;
      font-size: 1.1rem;
      text-align: center;
      font-style: italic;
      animation: fadeIn 0.5s;
      padding: 15px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 15px;
      border: 2px dashed #8b5cf6;
    }
    .ask-refresh-btn {
      margin-top: 16px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #4b5563;
      font-size: 1rem;
      padding: 10px 24px;
      border-radius: 25px;
      border: 1px solid #d1d5db;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .ask-refresh-btn:hover {
      background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .ask-refresh-btn:active {
      transform: translateY(0);
    }
    .ask-refresh-btn:focus {
      outline: 2px solid #8b5cf6;
      outline-offset: 2px;
    }
    
    /* Status indicator */
    .status-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10b981;
      border: 3px solid white;
      animation: status-pulse 2s infinite;
    }
    .status-indicator.recording {
      background: #ef4444;
      animation: status-recording 0.8s infinite;
    }
    @keyframes status-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes status-recording {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.2); }
    }
    
    /* Voice Commands Help */
    .voice-help {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(139, 92, 246, 0.2);
      backdrop-filter: blur(10px);
      max-width: 300px;
      display: none;
      z-index: 1000;
    }
    .voice-help h4 {
      margin: 0 0 10px 0;
      color: #8b5cf6;
    }
    .voice-command {
      margin: 5px 0;
      font-size: 0.9rem;
    }
    .voice-command strong {
      color: #8b5cf6;
    }
    
    /* Keyboard shortcuts */
    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      display: none;
    }
    
    @media (max-width: 700px) {
      .ask-title { font-size: 2rem; }
      .ask-desc { font-size: 1rem; }
      .ask-mic-btn { width: 70px; height: 70px; font-size: 1.5rem; }
      .ask-result, .ask-loading { font-size: 1rem; }
      .quick-actions { gap: 8px; }
      .quick-btn { font-size: 0.8rem; padding: 6px 12px; }
      .conversation-container { max-height: 250px; }
      .realtime-data { gap: 8px; }
      .data-card { min-width: 100px; }
    }
  </style>
</head>
<body>
  <div class="ask-center">
    <div class="ask-title">Murmu</div>
    <div class="ask-desc">Ask me about destinations, flights, hotels, and travel tips</div>
    
    <!-- Real-time Data Display -->
    <div class="realtime-data" id="realtimeData">
      <div class="data-card">
        <div class="data-label">Weather</div>
        <div class="data-value" id="weatherData">Loading...</div>
      </div>
      <div class="data-card">
        <div class="data-label">USD/EUR</div>
        <div class="data-value" id="currencyData">Loading...</div>
      </div>
      <div class="data-card">
        <div class="data-label">Flight Deals</div>
        <div class="data-value" id="flightData">Loading...</div>
      </div>
    </div>
    
    <!-- Travel Checklist -->
    <div class="checklist-container" id="checklistContainer">
      <div class="checklist-header">
        <div class="checklist-title">Travel Checklist</div>
        <button class="checklist-toggle" id="checklistToggle">√ó</button>
      </div>
      <div id="checklistItems">
        <div class="checklist-item">
          <input type="checkbox" id="check1">
          <label for="check1">Passport and visa documents</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check2">
          <label for="check2">Travel insurance</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check3">
          <label for="check3">Flight tickets</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check4">
          <label for="check4">Hotel reservations</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check5">
          <label for="check5">Currency exchange</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="check6">
          <label for="check6">Packing essentials</label>
        </div>
      </div>
    </div>
    
    <!-- Quick Action Buttons -->
    <div class="quick-actions">
      <button class="quick-btn" data-action="destinations">üåç Destinations</button>
      <button class="quick-btn" data-action="flights">‚úàÔ∏è Flights</button>
      <button class="quick-btn" data-action="hotels">üè® Hotels</button>
      <button class="quick-btn" data-action="budget">üí∞ Budget</button>
      <button class="quick-btn" data-action="weather">üå§Ô∏è Weather</button>
      <button class="quick-btn" data-action="visa">üìã Visa</button>
      <button class="quick-btn" data-action="insurance">üõ°Ô∏è Insurance</button>
      <button class="quick-btn" data-action="packing">üß≥ Packing</button>
    </div>
    
    <select id="langSelect" style="margin-bottom:20px; padding:8px 18px; border-radius:8px; border:1px solid #e5e7eb; font-size:1rem; font-family:inherit; outline:none; background:white;">
      <option value="en-US">English</option>
      <option value="hi-IN">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
      <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
      <option value="ja-JP">Êó•Êú¨Ë™û</option>
    </select>
    
    <button class="ask-mic-btn" id="micBtn" tabindex="0">
      <i class="fa-solid fa-microphone"></i>
      <div class="status-indicator" id="statusIndicator"></div>
    </button>
    
    <!-- Text Input for Offline Mode -->
    <div id="textInputContainer" style="display:none; margin:20px 0; width:100%; max-width:400px;">
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" id="textInput" placeholder="Type your travel question..." 
               style="flex:1; padding:12px 16px; border:2px solid #e5e7eb; border-radius:25px; font-size:1rem; outline:none; transition:border-color 0.3s;">
        <button id="sendBtn" style="padding:12px 20px; background:#8b5cf6; color:white; border:none; border-radius:25px; cursor:pointer; font-size:1rem;">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
    
    <!-- Conversation History -->
    <div class="conversation-container" id="conversationContainer">
      <div class="conversation-item bot">
        <div class="conversation-label">Travel Agent</div>
        <div class="conversation-text">Hello! I'm your personal travel agent. How can I help you plan your next adventure? You can ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!</div>
      </div>
    </div>
    
    <div id="askLoading" class="ask-loading" style="display:none;">
      <i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i>
      Listening...
    </div>
    <div id="askResult" class="ask-result" style="display:none;"></div>
    
    <button class="ask-refresh-btn" id="refreshBtn" tabindex="0">
      <i class="fa-solid fa-rotate-right" style="margin-right:6px;"></i> New Conversation
    </button>
  </div>

  <!-- Voice Commands Help -->
  <div class="voice-help" id="voiceHelp">
    <h4>Voice Commands</h4>
    <div class="voice-command"><strong>"Show checklist"</strong> - Open travel checklist</div>
    <div class="voice-command"><strong>"Voice commands"</strong> - Show this help</div>
    <div class="voice-command"><strong>"Book flight to [city]"</strong> - Flight booking</div>
    <div class="voice-command"><strong>"Weather in [city]"</strong> - Get weather info</div>
    <div class="voice-command"><strong>"Currency in [country]"</strong> - Exchange rates</div>
    <div class="voice-command"><strong>"Clear conversation"</strong> - Start fresh</div>
  </div>

  <!-- Keyboard Shortcuts Hint -->
  <div class="keyboard-hint" id="keyboardHint">
    Press 'H' for voice commands help, 'C' for checklist, 'Space' to speak
  </div>

  <script>
    const micBtn = document.getElementById('micBtn');
    const askResult = document.getElementById('askResult');
    const askLoading = document.getElementById('askLoading');
    const langSelect = document.getElementById('langSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const conversationContainer = document.getElementById('conversationContainer');
    const statusIndicator = document.getElementById('statusIndicator');
    const quickButtons = document.querySelectorAll('.quick-btn');
    const checklistContainer = document.getElementById('checklistContainer');
    const checklistToggle = document.getElementById('checklistToggle');
    const voiceHelp = document.getElementById('voiceHelp');
    const keyboardHint = document.getElementById('keyboardHint');
    const realtimeData = document.getElementById('realtimeData');
    
    let recognizing = false;
    let recognition;
    let currentLang = langSelect.value;
    let conversationHistory = [];
    let isChecklistVisible = false;
    let isVoiceHelpVisible = false;

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => console.log('ServiceWorker registered'))
        .catch(error => console.log('ServiceWorker registration failed'));
    }

    // Offline detection and functionality
    let isOnline = navigator.onLine;
    
    function updateOnlineStatus() {
      isOnline = navigator.onLine;
      updateOfflineUI();
    }
    
    function updateOfflineUI() {
      const micBtn = document.getElementById('micBtn');
      const statusIndicator = document.getElementById('statusIndicator');
      const offlineNotice = document.getElementById('offlineNotice');
      const textInputContainer = document.getElementById('textInputContainer');
      
      if (!isOnline) {
        // Disable voice features when offline
        micBtn.disabled = true;
        micBtn.title = 'Voice features unavailable offline';
        statusIndicator.style.background = '#6b7280';
        
        // Show offline notice
        if (!offlineNotice) {
          const notice = document.createElement('div');
          notice.id = 'offlineNotice';
          notice.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          `;
          notice.innerHTML = 'üì° Offline Mode - Voice features disabled';
          document.body.appendChild(notice);
        }
        
        // Show text input container
        textInputContainer.style.display = 'block';
        
        // Update conversation to inform user
        if (conversationContainer.children.length === 1) {
          addConversationItem('bot', 'You\'re currently offline. I can still help with travel information, but voice features are disabled. You can use the quick action buttons or type your questions.');
        }
      } else {
        // Re-enable voice features when online
        micBtn.disabled = false;
        micBtn.title = 'Click to speak';
        statusIndicator.style.background = '#10b981';
        
        // Hide text input container
        textInputContainer.style.display = 'none';
        
        // Remove offline notice
        const offlineNotice = document.getElementById('offlineNotice');
        if (offlineNotice) {
          offlineNotice.remove();
        }
      }
    }
    
    // Listen for online/offline events
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Check initial status
    updateOnlineStatus();

    // Real-time Data Simulation
    function updateRealtimeData() {
      const weatherData = document.getElementById('weatherData');
      const currencyData = document.getElementById('currencyData');
      const flightData = document.getElementById('flightData');
      
      if (!isOnline) {
        // Show offline indicators
        weatherData.textContent = 'Offline';
        currencyData.textContent = 'Offline';
        flightData.textContent = 'Offline';
        return;
      }
      
      // Simulate real-time updates
      const weatherConditions = ['‚òÄÔ∏è 72¬∞F', 'üå§Ô∏è 68¬∞F', '‚õÖ 75¬∞F', 'üåßÔ∏è 65¬∞F'];
      const currencyRates = ['$1.08', '$1.12', '$1.05', '$1.15'];
      const flightDeals = ['$299', '$349', '$399', '$449'];
      
      weatherData.textContent = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
      currencyData.textContent = currencyRates[Math.floor(Math.random() * currencyRates.length)];
      flightData.textContent = flightDeals[Math.floor(Math.random() * flightDeals.length)];
    }

    // Update data every 30 seconds
    setInterval(updateRealtimeData, 30000);
    updateRealtimeData();

    // Checklist functionality
    function toggleChecklist() {
      isChecklistVisible = !isChecklistVisible;
      checklistContainer.style.display = isChecklistVisible ? 'block' : 'none';
    }

    // Voice commands help
    function toggleVoiceHelp() {
      isVoiceHelpVisible = !isVoiceHelpVisible;
      voiceHelp.style.display = isVoiceHelpVisible ? 'block' : 'none';
    }

    // Handle checklist item completion
    document.querySelectorAll('#checklistItems input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const item = this.closest('.checklist-item');
        if (this.checked) {
          item.classList.add('completed');
        } else {
          item.classList.remove('completed');
        }
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'h' || e.key === 'H') {
        toggleVoiceHelp();
        showKeyboardHint('Voice commands help toggled');
      } else if (e.key === 'c' || e.key === 'C') {
        toggleChecklist();
        showKeyboardHint('Checklist toggled');
      } else if (e.key === ' ' && !recognizing) {
        e.preventDefault();
        if (recognition) recognition.start();
      }
    });

    function showKeyboardHint(message) {
      keyboardHint.textContent = message;
      keyboardHint.style.display = 'block';
      setTimeout(() => {
        keyboardHint.style.display = 'none';
      }, 2000);
    }

    // Add conversation item
    function addConversationItem(speaker, text) {
      const item = document.createElement('div');
      item.className = `conversation-item ${speaker}`;
      item.innerHTML = `
        <div class="conversation-label">${speaker === 'user' ? 'You' : 'Travel Agent'}</div>
        <div class="conversation-text">${text}</div>
      `;
      conversationContainer.appendChild(item);
      conversationContainer.scrollTop = conversationContainer.scrollHeight;
      
      // Store in history
      conversationHistory.push({ speaker, text, timestamp: new Date() });
    }

    // Enhanced voice command processing
    function processVoiceCommand(input) {
      const lowerInput = input.toLowerCase();
      
      if (lowerInput.includes('show checklist') || lowerInput.includes('open checklist')) {
        toggleChecklist();
        return "I've opened your travel checklist. You can check off items as you complete them!";
      }
      
      if (lowerInput.includes('voice commands') || lowerInput.includes('help')) {
        toggleVoiceHelp();
        return "I've shown the voice commands help. You can also press 'H' on your keyboard for quick access!";
      }
      
      if (lowerInput.includes('book flight to') || lowerInput.includes('book a flight to')) {
        const destination = input.match(/to\s+([a-zA-Z\s]+)/i);
        if (destination) {
          return `I'll help you book a flight to ${destination[1].trim()}. Let me search for the best deals and available dates for you.`;
        }
      }
      
      if (lowerInput.includes('weather in') || lowerInput.includes('weather for')) {
        const city = input.match(/in\s+([a-zA-Z\s]+)/i) || input.match(/for\s+([a-zA-Z\s]+)/i);
        if (city) {
          return `Let me check the weather for ${city[1].trim()}. I'll provide you with current conditions and forecast.`;
        }
      }
      
      if (lowerInput.includes('currency in') || lowerInput.includes('exchange rate')) {
        const country = input.match(/in\s+([a-zA-Z\s]+)/i);
        if (country) {
          return `I'll get you the current exchange rates for ${country[1].trim()}. This will help you plan your budget better.`;
        }
      }
      
      if (lowerInput.includes('clear conversation') || lowerInput.includes('new conversation')) {
        clearConversation();
        return "I've cleared our conversation. We can start fresh!";
      }
      
      // Default to regular travel response
      return getTravelResponse(input, currentLang);
    }

    function clearConversation() {
      conversationContainer.innerHTML = `
        <div class="conversation-item bot">
          <div class="conversation-label">Travel Agent</div>
          <div class="conversation-text">Hello! I'm your personal travel agent. How can I help you plan your next adventure? You can ask me about destinations, flights, hotels, and travel tips, or use the quick action buttons above. Try saying "show checklist" or "voice commands" for more features!</div>
        </div>
      `;
      conversationHistory = [];
      askResult.style.display = 'none';
      askLoading.style.display = 'none';
    }

    // Handle quick action buttons
    quickButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        const actionText = btn.textContent.replace(/[üåç‚úàÔ∏èüè®üí∞üå§Ô∏èüìãüõ°Ô∏èüß≥]/g, '').trim();
        
        // Add user message
        addConversationItem('user', `I want to know about ${actionText.toLowerCase()}`);
        
        // Get bot response
        const response = getTravelResponse(action, currentLang);
        addConversationItem('bot', response);
        
        // Speak the response
        speakResponse(response);
      });
    });

    // Speak response function
    function speakResponse(text) {
      if ('speechSynthesis' in window) {
        const utter = new window.SpeechSynthesisUtterance(text);
        utter.lang = currentLang;
        utter.onstart = () => { 
          micBtn.disabled = true; 
          statusIndicator.classList.add('recording');
        };
        utter.onend = () => { 
          micBtn.disabled = false; 
          statusIndicator.classList.remove('recording');
        };
        window.speechSynthesis.onvoiceschanged = () => {
          const voices = window.speechSynthesis.getVoices();
          utter.voice = voices.find(v => v.lang === currentLang) || null;
          window.speechSynthesis.speak(utter);
        };
        const voices = window.speechSynthesis.getVoices();
        if (voices.length) {
          utter.voice = voices.find(v => v.lang === currentLang) || null;
          window.speechSynthesis.speak(utter);
        }
      }
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = currentLang;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        recognizing = true;
        micBtn.classList.add('recording');
        statusIndicator.classList.add('recording');
        askLoading.textContent = 'Listening...';
        askLoading.style.display = '';
        askResult.style.display = 'none';
      };
      
      recognition.onend = () => {
        recognizing = false;
        micBtn.classList.remove('recording');
        statusIndicator.classList.remove('recording');
        if (!askResult.textContent) askLoading.style.display = 'none';
      };
      
      recognition.onerror = (event) => {
        recognizing = false;
        micBtn.classList.remove('recording');
        statusIndicator.classList.remove('recording');
        askLoading.textContent = 'Could not hear you. Try again!';
        setTimeout(() => askLoading.style.display = 'none', 2000);
      };
      
      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        askLoading.textContent = 'Processing your travel request...';
        
        // Add user message to conversation
        addConversationItem('user', transcript);
        
        try {
          // Process voice command or get travel agent response
          const response = processVoiceCommand(transcript);
          addConversationItem('bot', response);
          askLoading.style.display = 'none';
          askResult.style.display = '';

          // Speak the response
          speakResponse(response);
        } catch (err) {
          const errorMsg = 'Error: ' + (err?.message || err);
          addConversationItem('bot', errorMsg);
          askLoading.style.display = 'none';
        }
      };

      langSelect.addEventListener('change', () => {
        currentLang = langSelect.value;
        recognition.lang = currentLang;
      });
    } else {
      micBtn.disabled = true;
      addConversationItem('bot', 'Sorry, your browser does not support voice input.');
    }

    micBtn.addEventListener('click', () => {
      if (recognition && !recognizing) {
        recognition.start();
      }
    });

    refreshBtn.addEventListener('click', () => {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      clearConversation();
    });

    // Event listeners for accessibility
    micBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (recognition && !recognizing) {
          recognition.start();
        }
      }
    });

    refreshBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        clearConversation();
      }
    });

    // Show keyboard hint on first load
    setTimeout(() => {
      showKeyboardHint('Press H for help, C for checklist, Space to speak');
    }, 3000);

    // Text input functionality for offline mode
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    
    function handleTextInput() {
      const text = textInput.value.trim();
      if (text) {
        // Add user message
        addConversationItem('user', text);
        
        // Get bot response
        const response = getTravelResponse(text, currentLang);
        addConversationItem('bot', response);
        
        // Clear input
        textInput.value = '';
        
        // Focus back to input for continued conversation
        textInput.focus();
      }
    }
    
    // Handle send button click
    sendBtn.addEventListener('click', handleTextInput);
    
    // Handle Enter key in text input
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleTextInput();
      }
    });
    
    // Focus text input when it becomes visible
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          const textInputContainer = document.getElementById('textInputContainer');
          if (textInputContainer.style.display === 'block') {
            textInput.focus();
          }
        }
      });
    });
    
    observer.observe(document.getElementById('textInputContainer'), {
      attributes: true,
      attributeFilter: ['style']
    });
  </script>
</body>
</html>
